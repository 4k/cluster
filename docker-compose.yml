# Universal Docker Compose Configuration
# Works on Windows WSL, macOS, Linux, and Raspberry Pi 5
#
# ┌─────────────────────────────────────────────────────────────────────┐
# │ BUILDKIT REQUIREMENT                                                 │
# ├─────────────────────────────────────────────────────────────────────┤
# │ This project uses BuildKit cache mounts for faster pip installs     │
# │                                                                      │
# │ Options (choose one):                                               │
# │  1. Use wrapper scripts (RECOMMENDED):                              │
# │     Windows:  .\build.ps1 -Detached                                 │
# │     Linux:    ./build.sh --detached                                 │
# │     Make:     make dev                                              │
# │                                                                      │
# │  2. Enable BuildKit globally in daemon.json:                        │
# │     { "features": { "buildkit": true } }                            │
# │                                                                      │
# │  3. Set environment variables (manual):                             │
# │     export DOCKER_BUILDKIT=1                                        │
# │     export COMPOSE_DOCKER_CLI_BUILD=1                               │
# │                                                                      │
# │ NOTE: BuildKit is enabled by default in Docker 23.0+               │
# └─────────────────────────────────────────────────────────────────────┘

services:
  voice-assistant:
    build:
      context: .
      dockerfile: Dockerfile
      target: development
    container_name: voice-assistant
    
    volumes:
      # Source code and data
      - ./src:/app/src
      - ./config:/app/config
      - ./data:/app/data
      - ./models:/app/models
      - ./voices:/app/voices
      - ./logs:/app/logs
      # Model configuration (single source of truth)
      - ./models.json:/app/models.json
      # Environment file for reference (not mounted in production)
      - ./env.example:/app/env.example
      
      # Device access (conditional based on platform)
      - /dev/snd:/dev/snd:rw
      - /dev/video0:/dev/video0:rw
      - /dev/fb0:/dev/fb0:rw
      - /dev/fb1:/dev/fb1:rw
      - /tmp/.X11-unix:/tmp/.X11-unix:rw
    
    # Load all environment variables from .env file
    env_file:
      - .env
      
    environment:
      # Only set container-specific variables that aren't in .env
      - PYTHONPATH=/app
      - DISPLAY=${DISPLAY:-:0}  # X11 display for GUI (host-specific)
    
    devices:
      # Device access
      - /dev/snd:/dev/snd:rw
      - /dev/video0:/dev/video0:rw
      - /dev/fb0:/dev/fb0:rw
      - /dev/fb1:/dev/fb1:rw
    
    privileged: true
    stdin_open: true
    tty: true
    restart: unless-stopped
    
    networks:
      - voice-assistant-net
    
    deploy:
      resources:
        limits:
          memory: 8G
          cpus: '2.0'
        reservations:
          memory: 2G
          cpus: '1.0'
    
    command: ["python", "src/main.py"]

volumes:
  voice_data:
  voice_models:
  voice_voices:
  voice_config:
  voice_logs:

networks:
  voice-assistant-net:
    driver: bridge